generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS (SQLite does not support enums, using String fields instead)
// ============================================

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id       String  @id @default(uuid())
  fullName String  @map("full_name")
  phone    String  @unique
  password String
  address  String?
  role     String  @default("USER")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  testResults   TestResult[]
  refreshTokens RefreshToken[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// ============================================
// APPLICATION FORMS
// ============================================

model Application {
  id          String  @id @default(uuid())
  fullName    String  @map("full_name")
  phone       String
  companyName String? @map("company_name")
  message     String?
  status      String  @default("PENDING")

  createdAt DateTime @default(now()) @map("created_at")

  @@map("applications")
}

// ============================================
// DIAGNOSTICS / TESTS
// ============================================

model Test {
  id              String  @id @default(uuid())
  title           String
  slug            String  @unique
  isActive        Boolean @default(true) @map("is_active")
  startQuestionId String? @map("start_question_id")

  questions   Question[]
  testResults TestResult[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("tests")
}

model Question {
  id              String  @id @default(uuid())
  testId          String  @map("test_id")
  text            String
  order           Int
  isStartQuestion Boolean @default(false) @map("is_start_question")

  options     Option[]
  nextOptions Option[] @relation("NextQuestion")

  test Test @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@map("questions")
}

model Option {
  id             String  @id @default(uuid())
  questionId     String  @map("question_id")
  text           String
  order          Int
  nextQuestionId String? @map("next_question_id")
  feedbackText   String? @map("feedback_text")
  isTerminal     Boolean @default(false) @map("is_terminal")

  question     Question  @relation(fields: [questionId], references: [id], onDelete: Cascade)
  nextQuestion Question? @relation("NextQuestion", fields: [nextQuestionId], references: [id], onDelete: SetNull)

  @@map("options")
}

model TestResult {
  id      String @id @default(uuid())
  userId  String @map("user_id")
  testId  String @map("test_id")
  result  String
  answers Json

  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  test Test @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@map("test_results")
}

// ============================================
// FILE MANAGEMENT
// ============================================

model File {
  id           String @id @default(uuid())
  filename     String @unique
  originalName String @map("original_name")
  mimetype     String
  size         Int
  path         String

  createdAt DateTime @default(now()) @map("created_at")

  blogPosts BlogPost[]

  @@map("files")
}

// ============================================
// BLOG / CONTENT
// ============================================

model BlogPost {
  id      String  @id @default(uuid())
  title   String
  slug    String  @unique
  imageId String? @map("image_id")
  content String
  status  String  @default("DRAFT")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  image File? @relation(fields: [imageId], references: [id])

  @@map("blog_posts")
}

// ============================================
// BUSINESS CASES
// ============================================

model BusinessCase {
  id             String    @id @default(uuid())
  salesNetworkId String    @map("sales_network_id")
  problem        String
  solution       String
  result         String
  dateFrom       DateTime? @map("date_from")
  dateTo         DateTime? @map("date_to")

  salesNetwork SalesNetwork @relation(fields: [salesNetworkId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("business_cases")
}

// ============================================
// ADMIN LOOKUPS (simple CRUD)
// ============================================

model Diagnostic {
  id   String @id @default(uuid())
  name String

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("diagnostics")
}

model SalesNetwork {
  id   String @id @default(uuid())
  name String

  businessCases BusinessCase[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("sales_networks")
}
