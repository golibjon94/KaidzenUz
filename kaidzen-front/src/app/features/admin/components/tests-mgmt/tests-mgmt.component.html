<div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
  <div class="p-6 border-b border-gray-100 flex items-center justify-between">
    <h3 class="text-lg font-bold">Testlar boshqaruvi</h3>
    <button nz-button nzType="primary" (click)="showModal()">
      <span nz-icon nzType="plus"></span> Yangi test
    </button>
  </div>

  @if (!loading() && tests().length === 0) {
    <div class="p-8 text-center">
      <nz-empty nzNotFoundContent="Hozircha testlar yo'q"></nz-empty>
    </div>
  } @else {
    <nz-table #testsTable [nzData]="tests()" [nzLoading]="loading()">
      <thead>
        <tr>
          <th>Nomi</th>
          <th>Slug</th>
          <th>Savollar</th>
          <th>Holati</th>
          <th>Yaratilgan</th>
          <th>Amallar</th>
        </tr>
      </thead>
      <tbody>
        @for (data of testsTable.data; track data.id) {
          <tr>
            <td>
              <div class="font-medium">{{ data.title }}</div>
              <div class="text-xs text-gray-500 max-w-xs truncate">{{ data.description }}</div>
            </td>
            <td><code class="bg-gray-100 px-2 py-1 rounded text-xs">{{ data.slug }}</code></td>
            <td>
              <nz-tag [nzColor]="'blue'">{{ data._count?.questions || 0 }} ta savol</nz-tag>
            </td>
            <td>
              <nz-switch
                [ngModel]="data.isActive"
                (ngModelChange)="toggleActive(data.id)"
                [nzCheckedChildren]="checkedTemplate"
                [nzUnCheckedChildren]="unCheckedTemplate"
              ></nz-switch>
              <ng-template #checkedTemplate><span nz-icon nzType="check"></span></ng-template>
              <ng-template #unCheckedTemplate><span nz-icon nzType="close"></span></ng-template>
            </td>
            <td>{{ data.createdAt | date:'dd.MM.yyyy' }}</td>
            <td>
              <button nz-button nzType="text" nzShape="circle" class="text-blue-600 hover:text-blue-800 mr-2" (click)="editTest(data.id)">
                <span nz-icon nzType="edit"></span>
              </button>
              <button
                nz-button
                nzType="text"
                nzShape="circle"
                nzDanger
                nz-popconfirm
                nzPopconfirmTitle="Haqiqatan ham o'chirmoqchimisiz?"
                (nzOnConfirm)="deleteTest(data.id)"
              >
                <span nz-icon nzType="delete"></span>
              </button>
            </td>
          </tr>
        }
      </tbody>
    </nz-table>
  }
</div>

<nz-modal
  [(nzVisible)]="isVisible"
  [nzTitle]="editMode() ? 'Testni tahrirlash' : 'Yangi test yaratish'"
  (nzOnCancel)="handleCancel()"
  (nzOnOk)="submitForm()"
  [nzOkLoading]="isSubmitting()"
  nzWidth="900px"
  nzCentered
>
  <ng-container *nzModalContent>
    <form [formGroup]="testForm" nz-form nzLayout="vertical">
      <div class="grid grid-cols-2 gap-4">
        <nz-form-item>
          <nz-form-label nzRequired>Test nomi</nz-form-label>
          <nz-form-control nzErrorTip="Iltimos nomini kiriting">
            <input nz-input formControlName="title" placeholder="Test nomi" />
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label nzRequired>Slug (URL)</nz-form-label>
          <nz-form-control nzErrorTip="Iltimos slug kiriting">
            <input nz-input formControlName="slug" placeholder="test-nomi" />
          </nz-form-control>
        </nz-form-item>
      </div>

      <nz-form-item>
        <nz-form-label>Tavsif</nz-form-label>
        <nz-form-control>
          <textarea nz-input formControlName="description" rows="3" placeholder="Test haqida qisqacha"></textarea>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label>Holati</nz-form-label>
        <nz-form-control>
          <nz-switch formControlName="isActive"></nz-switch>
          <span class="ml-2">Faol (saytda ko'rinadi)</span>
        </nz-form-control>
      </nz-form-item>

      <nz-tabset>
        <nz-tab [nzTitle]="questionsTitle">
          <ng-template #questionsTitle>
            <span nz-icon nzType="question-circle"></span> Savollar ({{ questions.length }})
          </ng-template>

          <div class="max-h-[500px] overflow-y-auto pr-2">
            <div formArrayName="questions">
              @for (question of questions.controls; track $index) {
                <div [formGroupName]="$index" class="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200 relative group hover:border-blue-300 transition-colors">
                  <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200">
                    <h4 class="font-bold text-gray-700 flex items-center">
                      <span class="bg-blue-100 text-blue-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded">#{{ $index + 1 }}</span>
                      Savol
                    </h4>
                    <button nz-button nzType="text" nzDanger (click)="removeQuestion($index)" nz-tooltip="Savolni o'chirish">
                      <span nz-icon nzType="delete"></span>
                    </button>
                  </div>

                  <div class="grid grid-cols-12 gap-4 mb-4">
                    <div class="col-span-10">
                      <nz-form-item class="mb-0">
                        <nz-form-control nzErrorTip="Savol matni kiritilishi shart">
                          <input nz-input formControlName="text" placeholder="Savol matni" />
                        </nz-form-control>
                      </nz-form-item>
                    </div>
                    <div class="col-span-2">
                      <nz-form-item class="mb-0">
                        <nz-form-control>
                          <nz-input-number formControlName="order" [nzMin]="1" class="w-full" placeholder="Tartib"></nz-input-number>
                        </nz-form-control>
                      </nz-form-item>
                    </div>
                  </div>

                  <div formArrayName="options" class="pl-4 border-l-2 border-blue-100 bg-white p-3 rounded-r-lg">
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Variantlar</p>

                    @for (option of getOptions($index).controls; track optionIndex; let optionIndex = $index) {
                      <div [formGroupName]="optionIndex" class="flex gap-2 mb-3 items-start">
                        <nz-form-item class="flex-1 mb-0">
                          <nz-form-control nzErrorTip="Variant matni kerak">
                            <input nz-input formControlName="text" placeholder="Variant matni" />
                          </nz-form-control>
                        </nz-form-item>

                        <nz-form-item class="mb-0" style="width: 100px">
                          <nz-form-control>
                            <nz-input-number formControlName="score" [nzMin]="0" placeholder="Ball" class="w-full"></nz-input-number>
                          </nz-form-control>
                        </nz-form-item>

                        <button nz-button nzType="text" nzDanger (click)="removeOption($index, optionIndex)" class="mt-1">
                          <span nz-icon nzType="minus-circle"></span>
                        </button>
                      </div>
                    }

                    <button nz-button nzType="dashed" nzSize="small" class="w-full mt-2" (click)="addOption($index)">
                      <span nz-icon nzType="plus"></span> Variant qo'shish
                    </button>
                  </div>
                </div>
              }

              <button nz-button nzType="dashed" class="w-full py-3 flex items-center justify-center gap-2 text-lg" (click)="addQuestion()">
                <span nz-icon nzType="plus"></span> Yangi savol qo'shish
              </button>
            </div>
          </div>
        </nz-tab>

        <nz-tab [nzTitle]="logicTitle">
          <ng-template #logicTitle>
            <span nz-icon nzType="aim"></span> Natijalar ({{ resultLogic.length }})
          </ng-template>

          <div class="max-h-[500px] overflow-y-auto pr-2">
            <div formArrayName="resultLogic">
              @for (logic of resultLogic.controls; track $index) {
                <div [formGroupName]="$index" class="bg-gray-50 p-4 rounded-lg mb-4 border border-gray-200 hover:border-green-300 transition-colors">
                  <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200">
                    <h4 class="font-bold text-gray-700 flex items-center">
                      <span class="bg-green-100 text-green-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded">Natija #{{ $index + 1 }}</span>
                    </h4>
                    <button nz-button nzType="text" nzDanger (click)="removeResultLogic($index)">
                      <span nz-icon nzType="delete"></span>
                    </button>
                  </div>

                  <div class="grid grid-cols-2 gap-4 mb-4 bg-white p-3 rounded border border-gray-100">
                    <nz-form-item class="mb-0">
                      <nz-form-label nzNoColon>Min Ball</nz-form-label>
                      <nz-form-control>
                        <nz-input-number formControlName="minScore" [nzMin]="0" class="w-full"></nz-input-number>
                      </nz-form-control>
                    </nz-form-item>
                    <nz-form-item class="mb-0">
                      <nz-form-label nzNoColon>Max Ball</nz-form-label>
                      <nz-form-control>
                        <nz-input-number formControlName="maxScore" [nzMin]="0" class="w-full"></nz-input-number>
                      </nz-form-control>
                    </nz-form-item>
                  </div>

                  <nz-form-item>
                    <nz-form-label>Natija matni</nz-form-label>
                    <nz-form-control nzErrorTip="Natija matni kiritilishi shart">
                      <textarea nz-input formControlName="resultText" rows="2" placeholder="Sizning natijangiz..."></textarea>
                    </nz-form-control>
                  </nz-form-item>

                  <nz-form-item class="mb-0">
                    <nz-form-label>Tavsiya</nz-form-label>
                    <nz-form-control nzErrorTip="Tavsiya kiritilishi shart">
                      <textarea nz-input formControlName="recommendation" rows="3" placeholder="Bizning tavsiyamiz..."></textarea>
                    </nz-form-control>
                  </nz-form-item>
                </div>
              }

              <button nz-button nzType="dashed" class="w-full py-3 flex items-center justify-center gap-2 text-lg" (click)="addResultLogic()">
                <span nz-icon nzType="plus"></span> Natija logikasi qo'shish
              </button>
            </div>
          </div>
        </nz-tab>
      </nz-tabset>
    </form>
  </ng-container>
</nz-modal>
