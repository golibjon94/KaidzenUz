<div class="p-6 max-w-7xl mx-auto" ngSkipHydration>

  <div class="flex items-center justify-between mb-6 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
    <div>
      <h1 class="text-2xl font-bold text-gray-800 m-0">Testlar Boshqaruvi</h1>
      <p class="text-gray-500 text-sm">Tizimdagi barcha testlarni boshqarish</p>
    </div>
    <button nz-button nzType="primary" nzSize="large" (click)="showModal()" class="rounded-lg flex items-center gap-2">
      <span nz-icon nzType="plus"></span>
      Yangi test yaratish
    </button>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <nz-table #basicTable [nzData]="tests()" [nzLoading]="loading()" [nzPageSize]="10">
      <thead>
      <tr>
        <th nzWidth="300px">Test nomi</th>
        <th>Slug</th>
        <th>Savollar</th>
        <th>Holati</th>
        <th nzRight>Amallar</th>
      </tr>
      </thead>
      <tbody>
        @for (data of basicTable.data; track data.id) {
          <tr class="hover:bg-gray-50 transition-colors">
            <td>
              <div class="font-semibold text-gray-800">{{ data.title }}</div>
              <div class="text-xs text-gray-400 truncate max-w-xs">{{ data.description }}</div>
            </td>
            <td><code class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded">{{ data.slug }}</code></td>
            <td><nz-tag nzColor="processing">{{ data._count?.questions || 0 }} ta savol</nz-tag></td>
            <td>
              <nz-badge [nzStatus]="data.isActive ? 'success' : 'default'" [nzText]="data.isActive ? 'Faol' : 'Nofaol'"></nz-badge>
            </td>
            <td nzRight>
              <div class="flex gap-2">
                <button nz-button nzType="text" nzShape="circle" (click)="editTest(data.id)" class="text-blue-500 hover:bg-blue-50">
                  <span nz-icon nzType="edit"></span>
                </button>
                <button nz-button nzType="text" nzShape="circle" nzDanger
                        nz-popconfirm nzPopconfirmTitle="Haqiqatan ham o'chirmoqchimisiz?"
                        (nzOnConfirm)="deleteTest(data.id)">
                  <span nz-icon nzType="delete"></span>
                </button>
              </div>
            </td>
          </tr>
        }
      </tbody>
    </nz-table>
  </div>
</div>

<nz-modal
  [(nzVisible)]="isVisible"
  [nzTitle]="modalTitle"
  [nzWidth]="1000"
  (nzOnCancel)="handleCancel()"
  (nzOnOk)="submitForm()"
  [nzOkLoading]="isSubmitting()"
  [nzOkText]="editMode() ? 'Yangilash' : 'Saqlash'"
  nzClassName="custom-test-modal"
>
  <ng-template #modalTitle>
    <div class="flex items-center gap-2">
      <span nz-icon [nzType]="editMode() ? 'edit' : 'plus-circle'" class="text-blue-600"></span>
      <span>{{ editMode() ? 'Testni tahrirlash' : 'Yangi test yaratish' }}</span>
    </div>
  </ng-template>

  <ng-container *nzModalContent>
    <form [formGroup]="testForm" nz-form nzLayout="vertical" class="mt-4">
      <nz-tabs nzType="card" [nzAnimated]="false">

        <nz-tab nzTitle="Asosiy sozlamalar">
          <div class="grid grid-cols-2 gap-4 pt-4">
            <nz-form-item>
              <nz-form-label nzRequired>Test sarlavhasi</nz-form-label>
              <nz-form-control nzErrorTip="Sarlavha bo'sh bo'lmasligi kerak">
                <input nz-input formControlName="title" placeholder="Masalan: Psixologik test" />
              </nz-form-control>
            </nz-form-item>
            <nz-form-item>
              <nz-form-label nzRequired>Slug (URL)</nz-form-label>
              <nz-form-control>
                <input nz-input formControlName="slug" [readonly]="editMode()" />
              </nz-form-control>
            </nz-form-item>
          </div>
          <nz-form-item>
            <nz-form-label>Tavsif</nz-form-label>
            <nz-form-control>
              <textarea nz-input formControlName="description" rows="3"></textarea>
            </nz-form-control>
          </nz-form-item>
          <nz-form-item>
            <nz-form-label>Holati</nz-form-label>
            <nz-form-control>
              <nz-switch formControlName="isActive" nzCheckedChildren="Faol" nzUnCheckedChildren="Nofaol"></nz-switch>
            </nz-form-control>
          </nz-form-item>
        </nz-tab>

        <nz-tab [nzTitle]="'Savollar (' + questions.length + ')'">
          <div formArrayName="questions" class="space-y-6 pt-4 max-h-[500px] overflow-y-auto pr-2">
            @for (q of questions.controls; track q; let i = $index) {
              <div [formGroupName]="i" class="p-4 border rounded-xl bg-gray-50 relative">
                <button nz-button nzType="text" nzDanger class="absolute top-2 right-2" (click)="removeQuestion(i)">
                  <span nz-icon nzType="delete"></span>
                </button>

                <div class="flex gap-4 mb-4">
                  <div class="flex-1">
                    <label class="block text-xs font-bold mb-1 uppercase">#{{i + 1}} Savol matni</label>
                    <input nz-input formControlName="text" placeholder="Savolni kiriting..." />
                  </div>
                  <div class="w-24">
                    <label class="block text-xs font-bold mb-1 uppercase">Tartib</label>
                    <nz-input-number formControlName="order" class="w-full"></nz-input-number>
                  </div>
                </div>

                <div formArrayName="options" class="ml-6 space-y-2 border-l-2 pl-4 border-blue-200">
                  @for (opt of (q.get('options') | any).controls; track opt; let optIdx = $index) {
                    <div [formGroupName]="optIdx" class="flex gap-2 items-center">
                      <input nz-input formControlName="text" placeholder="Variant..." class="flex-1" />
                      <nz-input-number formControlName="score" nzPlaceHolder="Ball" class="w-20"></nz-input-number>
                      <button nz-button nzType="text" nzDanger (click)="removeOption(i, optIdx)">
                        <span nz-icon nzType="minus-circle"></span>
                      </button>
                    </div>
                  }
                  <button nz-button nzType="dashed" nzSize="small" (click)="addOption(i)">
                    <span nz-icon nzType="plus"></span> Variant qo'shish
                  </button>
                </div>
              </div>
            }
            <button nz-button nzType="dashed" nzBlock nzSize="large" (click)="addQuestion()">
              <span nz-icon nzType="plus"></span> Yangi savol qo'shish
            </button>
          </div>
        </nz-tab>

        <nz-tab nzTitle="Natija logikasi">
          <div formArrayName="resultLogic" class="space-y-4 pt-4">
            @for (logic of resultLogic.controls; track logic; let i = $index) {
              <div [formGroupName]="i" class="p-4 border rounded-lg bg-green-50">
                <div class="grid grid-cols-2 gap-4 mb-2">
                  <nz-input-number formControlName="minScore" nzPlaceHolder="Min Ball" class="w-full"></nz-input-number>
                  <nz-input-number formControlName="maxScore" nzPlaceHolder="Max Ball" class="w-full"></nz-input-number>
                </div>
                <input nz-input formControlName="resultText" placeholder="Natija nomi" class="mb-2" />
                <textarea nz-input formControlName="recommendation" placeholder="Tavsiya..."></textarea>
                <button nz-button nzType="link" nzDanger (click)="removeResultLogic(i)">O'chirish</button>
              </div>
            }
            <button nz-button nzType="dashed" nzBlock (click)="addResultLogic()">
              <span nz-icon nzType="aim"></span> Natija qo'shish
            </button>
          </div>
        </nz-tab>
      </nz-tabs>
    </form>
  </ng-container>
</nz-modal>
