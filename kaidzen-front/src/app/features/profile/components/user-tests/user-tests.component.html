<div class="p-6">
  <!-- Error message -->
  @if (error()) {
    <div class="mb-4 p-4 bg-red-50 border border-red-200 text-red-600 rounded-lg flex justify-between items-center">
      <span>{{ error() }}</span>
      <button (click)="error.set(null)" class="text-xl">&times;</button>
    </div>
  }

  <!-- Loading Skeleton -->
  @if (loading()) {
    <nz-skeleton [nzActive]="true" [nzParagraph]="{ rows: 10 }"></nz-skeleton>
  }

  <!-- Test Result -->
  @if (result()) {
    <nz-result
      nzStatus="success"
      nzTitle="Test muvaffaqiyatli yakunlandi!"
      [nzSubTitle]="'Sizning natijangiz: ' + result()!.score + ' ball'"
    >
      <div nz-result-content>
        <div class="bg-gray-50 p-6 rounded-xl border border-gray-100 mb-6">
          <h4 class="text-lg font-bold mb-2">Xulosa:</h4>
          <p class="text-gray-700 text-lg mb-4">{{ result()!.resultText }}</p>
          <h4 class="text-lg font-bold mb-2 text-blue-600">Tavsiyalarimiz:</h4>
          <p class="text-gray-600 italic leading-relaxed">{{ result()!.recommendation }}</p>
        </div>
      </div>
      <div nz-result-extra>
        <button nz-button nzType="primary" (click)="backToList()">Boshqa testlarni ko'rish</button>
      </div>
    </nz-result>
  }

  <!-- Test Questions -->
  @else if (selectedTest()) {
    <div class="animate-fade-in">
      <div class="flex items-center gap-4 mb-8">
        <button nz-button nzType="default" nzShape="circle" (click)="backToList()">
          <span nz-icon nzType="arrow-left"></span>
        </button>
        <div>
          <h2 class="text-2xl font-bold m-0">{{ selectedTest()!.title }}</h2>
          <p class="text-gray-500">{{ selectedTest()!.description }}</p>
        </div>
      </div>

      <div class="space-y-6 mb-8">
        @for (question of selectedTest()!.questions; track question.id; let i = $index) {
          <nz-card class="shadow-sm rounded-xl">
            <h3 class="text-lg font-bold mb-4">{{ i + 1 }}. {{ question.text }}</h3>
            <nz-radio-group
              class="flex flex-col gap-3"
              [ngModel]="selectedAnswers().get(question.id)"
              (ngModelChange)="selectOption(question.id, $event)"
            >
              @for (option of question.options; track option.id) {
                <label nz-radio [nzValue]="option.id" class="text-base py-1">
                  {{ option.text }}
                </label>
              }
            </nz-radio-group>
          </nz-card>
        }
      </div>

      <div class="sticky bottom-0 bg-white/80 backdrop-blur-md p-4 border-t flex justify-end">
        <button
          nz-button
          nzType="primary"
          nzSize="large"
          class="px-12 h-12 font-bold rounded-lg"
          [disabled]="!canSubmit() || submitting()"
          [nzLoading]="submitting()"
          (click)="submitTest()"
        >
          Testni topshirish
        </button>
      </div>
    </div>
  }

  <!-- Tests List -->
  @else if (!loading()) {
    <div class="animate-fade-in">
      <div class="mb-8">
        <h2 class="text-2xl font-bold text-gray-900">Diagnostik Testlar</h2>
        <p class="text-gray-500 text-lg">Biznesingizning zaif nuqtalarini aniqlash uchun testlardan o'ting.</p>
      </div>

      @if (tests().length === 0) {
        <div class="text-center py-20 bg-gray-50 rounded-2xl border-2 border-dashed">
          <span nz-icon nzType="info-circle" class="text-4xl text-gray-300 mb-4"></span>
          <p class="text-gray-400 text-lg">Hozircha testlar mavjud emas</p>
        </div>
      } @else {
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          @for (test of tests(); track test.id) {
            <nz-card
              class="hover:shadow-md transition-shadow rounded-2xl cursor-pointer group"
              (click)="selectTest(test.slug)"
            >
              <div class="flex justify-between items-start mb-4">
                <div class="w-12 h-12 bg-blue-50 rounded-xl flex items-center justify-center text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                  <span nz-icon nzType="file-text" class="text-2xl"></span>
                </div>
              </div>
              <h3 class="text-xl font-bold mb-2">{{ test.title }}</h3>
              <p class="text-gray-500 line-clamp-2 mb-6">{{ test.description }}</p>
              <div class="flex items-center text-blue-600 font-bold">
                Boshlash <span nz-icon nzType="right" class="ml-2"></span>
              </div>
            </nz-card>
          }
        </div>
      }
    </div>
  }
</div>
