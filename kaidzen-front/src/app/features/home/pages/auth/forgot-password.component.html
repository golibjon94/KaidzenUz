<div class="min-h-screen flex items-center justify-center bg-gray-100 px-4 py-12">
  <div class="w-full max-w-md">
    <!-- Logo -->
    <div class="text-center mb-8">
      <a routerLink="/">
        <div class="flex items-center justify-center gap-2 mb-4">
          <div class="w-11 h-11 bg-blue-600 rounded-xl flex items-center justify-center">
            <span class="text-white font-bold text-lg">K</span>
          </div>
          <span class="text-2xl font-extrabold text-blue-600">Sarash</span>
        </div>
      </a>
      <h1 class="text-xl font-bold text-gray-900">Parolni tiklash</h1>
      <p class="text-gray-500 text-sm mt-1">SMS orqali parolingizni yangilang</p>
    </div>

    <!-- Step indicator -->
    <div class="flex items-center justify-center gap-2 mb-6">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold"
             [class]="currentStep() >= 1 ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-500'">1</div>
        <span class="text-sm" [class]="currentStep() >= 1 ? 'text-blue-600 font-medium' : 'text-gray-400'">Telefon</span>
      </div>
      <div class="w-8 h-px bg-gray-300"></div>
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold"
             [class]="currentStep() >= 2 ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-500'">2</div>
        <span class="text-sm" [class]="currentStep() >= 2 ? 'text-blue-600 font-medium' : 'text-gray-400'">Tasdiqlash</span>
      </div>
      <div class="w-8 h-px bg-gray-300"></div>
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold"
             [class]="currentStep() >= 3 ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-500'">3</div>
        <span class="text-sm" [class]="currentStep() >= 3 ? 'text-blue-600 font-medium' : 'text-gray-400'">Yangi parol</span>
      </div>
    </div>

    <!-- Card -->
    <mat-card>
      <mat-card-content>

        <!-- ========== STEP 1: Phone ========== -->
        @if (currentStep() === 1) {
          <form [formGroup]="phoneForm" class="flex flex-col pt-4">

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Telefon raqam</mat-label>
              <span matTextPrefix>+998&nbsp;</span>
              <input matInput formControlName="phone"
                     placeholder="90 123 45 67" type="tel" maxlength="9">
              <mat-error>9 ta raqam kiriting</mat-error>
            </mat-form-field>

            <button mat-flat-button color="primary" type="button"
                    class="w-full !h-12 !text-base" [disabled]="isLoading()"
                    (click)="sendOtp()">
              @if (isLoading()) {
                <mat-spinner diameter="20" class="inline-block mr-2"></mat-spinner>
              }
              SMS kod yuborish
            </button>
          </form>
        }

        <!-- ========== STEP 2: OTP ========== -->
        @if (currentStep() === 2) {
          <form [formGroup]="otpForm" class="flex flex-col pt-4">

            <!-- Telefon raqam ko'rsatish -->
            <div class="flex items-center gap-2 mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
              <mat-icon class="text-blue-600">phone</mat-icon>
              <span class="text-sm text-blue-700 font-medium">+998{{ phoneForm.value.phone }} ga kod yuborildi</span>
            </div>

            <!-- Test rejimda OTP kodni ko'rsatish -->
            @if (testOtpCode()) {
              <div class="flex items-center gap-2 mb-3 p-3 bg-amber-50 rounded-lg border border-amber-200">
                <mat-icon class="text-amber-600">info</mat-icon>
                <span class="text-sm text-amber-700 font-medium">Test rejim — tasdiqlash kodi: <strong>{{ testOtpCode() }}</strong></span>
              </div>
            }

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>SMS kod</mat-label>
              <mat-icon matPrefix>sms</mat-icon>
              <input matInput formControlName="otpCode"
                     placeholder="4 xonali kod" maxlength="4" minlength="4" type="tel">
              <mat-error>Aniq 4 xonali kod kiriting</mat-error>
            </mat-form-field>

            <button mat-flat-button color="primary" type="button"
                    class="w-full !h-12 !text-base" [disabled]="isLoading()"
                    (click)="verifyOtp()">
              @if (isLoading()) {
                <mat-spinner diameter="20" class="inline-block mr-2"></mat-spinner>
              }
              Tasdiqlash
            </button>

            <!-- Resend with countdown -->
            <div class="text-center mt-3">
              @if (countdown() > 0) {
                <span class="text-sm text-gray-400">Qayta yuborish: {{ countdown() }}s</span>
              } @else {
                <button mat-button color="primary" type="button" (click)="resendOtp()"
                        [disabled]="isLoading()">
                  Qayta yuborish
                </button>
              }
            </div>
          </form>
        }

        <!-- ========== STEP 3: New Password ========== -->
        @if (currentStep() === 3) {
          <form [formGroup]="passwordForm" (ngSubmit)="handleResetPassword()" class="flex flex-col pt-4">

            <!-- Tasdiqlangan telefon -->
            <div class="flex items-center gap-2 mb-4 p-3 bg-green-50 rounded-lg border border-green-200">
              <mat-icon class="text-green-600">check_circle</mat-icon>
              <span class="text-sm text-green-700 font-medium">+998{{ phoneForm.value.phone }} — tasdiqlangan</span>
            </div>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Yangi parol</mat-label>
              <mat-icon matPrefix>lock_outline</mat-icon>
              <input matInput formControlName="newPassword"
                     [type]="hidePassword ? 'password' : 'text'"
                     placeholder="Kamida 6 ta belgi">
              <button mat-icon-button matSuffix type="button"
                      (click)="hidePassword = !hidePassword" tabindex="-1">
                <mat-icon>{{ hidePassword ? 'visibility_off' : 'visibility' }}</mat-icon>
              </button>
              <mat-error>Kamida 6 ta belgi</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Parolni tasdiqlang</mat-label>
              <mat-icon matPrefix>lock_outline</mat-icon>
              <input matInput formControlName="confirmPassword"
                     [type]="hidePassword ? 'password' : 'text'"
                     placeholder="Parolni qayta kiriting">
              <mat-error>Kamida 6 ta belgi</mat-error>
            </mat-form-field>

            <button mat-flat-button color="primary" type="submit"
                    class="w-full !h-12 !text-base" [disabled]="isLoading()">
              @if (isLoading()) {
                <mat-spinner diameter="20" class="inline-block mr-2"></mat-spinner>
              }
              Parolni yangilash
            </button>
          </form>
        }

        <!-- Login link -->
        <div class="text-center text-sm text-gray-500 mt-4">
          Parolingiz esda bormi?
          <a routerLink="/" class="text-blue-600 font-semibold ml-1">Kirish</a>
        </div>

      </mat-card-content>
    </mat-card>

    <!-- Footer -->
    <p class="text-center text-gray-400 text-xs mt-6 flex items-center justify-center gap-1">
      <mat-icon class="!text-sm">lock</mat-icon>
      Ma'lumotlaringiz xavfsiz himoyalangan
    </p>
  </div>
</div>
